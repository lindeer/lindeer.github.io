<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: Tech | 林鹿-Lindeer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta property="og:type" content="website">
<meta property="og:title" content="林鹿-Lindeer">
<meta property="og:url" content="http://www.lindeer.net/categories/Tech/page/2/index.html">
<meta property="og:site_name" content="林鹿-Lindeer">
<meta property="og:locale">
<meta property="article:author" content="glWesley">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">林鹿-Lindeer</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      
  
    <article id="post-android-text-width-trap" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2018/04/28/android-text-width-trap/">Android计算文本宽度的坑</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2018-04-28T03:48:31.000Z" itemprop="datePublished">Apr 28 2018</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>想实现自动缩放字体大小的功能，无论用第三方的控件还是<code>AppCompatTextView</code>都遇到一个问题：在滚动列表视图中显示有问题，在滚动过程中，明明有更大空间却用了一个小字体。没有时间细查实现，想着很简单就造个轮子。<br>想法很简单：计算每个非目标child的wrap_content宽度，用父宽度减去得availableWidth，再计算目标child的宽度，如果超过就减小字体值，直至合适的字体大小值出现。<br>然而实现后实际宽度比预期少那几个像素，使得相邻的文本折行了。</p>
<p>mRight是相邻文本TextView，mLeft是可绽放字体的TextView:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> time = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mode = MeasureSpec.getMode(widthMeasureSpec) &gt;&gt; <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> width = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">    mRight.measure(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> rightMinWidth = mRight.getMeasuredWidth();</span><br><span class="line">    MarginLayoutParams llp = (MarginLayoutParams) mLeft.getLayoutParams();</span><br><span class="line">    MarginLayoutParams rlp = (MarginLayoutParams) mRight.getLayoutParams();</span><br><span class="line">    <span class="keyword">int</span> available = width - rightMinWidth - rlp.leftMargin - rlp.rightMargin</span><br><span class="line">            - llp.leftMargin - llp.rightMargin;</span><br><span class="line"></span><br><span class="line">    Paint textPaint = mLeft.getPaint();</span><br><span class="line">    CharSequence cs = mLeft.getText();</span><br><span class="line">    String text = cs == <span class="keyword">null</span> ? <span class="keyword">null</span> : cs.toString();</span><br><span class="line">    <span class="keyword">float</span> textSize = mOriginTextSize;</span><br><span class="line">    textPaint.setTextSize(textSize);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> bounds = getTextSize(textPaint, text); bounds &gt; available;</span><br><span class="line">         bounds = getTextSize(textPaint, text)) &#123;</span><br><span class="line">        textSize -= <span class="number">2</span>;</span><br><span class="line">        textPaint.setTextSize(textSize);</span><br><span class="line">    &#125;</span><br><span class="line">    time = System.currentTimeMillis() - time;</span><br><span class="line">    Logger.d(TAG, <span class="string">&quot;onMeasure: mode=%d, width=%d, right=%d,&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; available=%d, textSize=%.2f, origin=%.2f, cost=%d&quot;</span>,</span><br><span class="line">            mode, width, rightMinWidth, available, textSize, mOriginTextSize, time);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTextSize</span><span class="params">(Paint paint, <span class="meta">@Nullable</span> String text)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    paint.getTextBounds(text, <span class="number">0</span>, text.length(), sTextBounds);</span><br><span class="line">    <span class="keyword">return</span> sTextBounds.width();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>网上查找了下<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/15398496">原因</a>，竟是计算字体宽度的方法使用的不对！在<code>getTextSize</code>中应该是<code>return sTextBounds.left + sTextBounds.width();</code> 太坑爹。<br>后来想到字体top和ascent, bottom和descent也是不一样的，是为记……</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-recyclerview-divider-by-viewtype" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2018/04/18/recyclerview-divider-by-viewtype/">RecyclerView区分视图类型的Divider</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2018-04-18T08:41:11.000Z" itemprop="datePublished">Apr 18 2018</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>我们都知道support库有一个DividerItemDecoration, 可以作为Item之间的分隔线(divider)。但它作用以后所有的item之间都会有这个分隔线，实际情况往往是：recyclerView中存在多种的视图类型(viewType), 我们只是需要在某一类型的视图后添加分隔线。<br>要实现这种分隔线效果并不是什么难事，既然是某一类型有这个分隔线，那在直接在这种视图的layout文件上增加如下一个bottomLine界面元素妥妥的:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">View</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;0.5dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;@color/colorGrayLight&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>但如果添加这样一个界面元素导致新增一层布局那感觉代价有点大。另外一种情况，如果当前这个视图由于某种原因存在padding，而期望的分隔线是穿透整个布局的，那添加bottomLine的做法也是行不通的；还有一种情况同一类型布局在一个页面有分隔线，在另一个页面没有分隔线；总之就是希望分隔线和视图内容无关。所以我们需要一种类似DividerItemDecoration的decoration，它能针对某些viewType起作用。</p>
<p>先要了解一下RecyclerView.ItemDecoration，它有2个重要的回调方法：<code>onDrawOver</code>和<code>getItemOffsets</code>。onDrawOver其实是一种应用多个item的方法，所以无论如何都需要一个遍历操作。需要理解的是getItemOffsets中outRect这个输出型参数，虽然是一个Rect类型，但并不表示任何范围，而只是一个item四周的间隔距离:<br><img src="https://upload-images.jianshu.io/upload_images/19161-46137967b9675b24.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="outRect参数各域的含义"></p>
<p>我们思路已经很清楚了: 在getItemOffsets中判断当前view的类型(parent.getChildViewHolder(view)), 如果是我们需要的类型设置对应的bottom；在onDrawOver中我们遍历recyclerView的child，同样如果是我们需要的类型将分隔线画在对应位置上就行了；这个decoration可以针对任意一种或者几种类型设置不种的drawable，我们当前用SparseArray存储，key就是视图的viewType<br><code>private final SparseArrayCompat&lt;Drawable&gt; mDividers = new SparseArrayCompat&lt;&gt;(2);</code><br>同时我们可以设置这个item的高度，当Drawable为null时相当于一个透明的间隙，不为null时具有强制指定的高度。<br>同样我们还要考虑方向：layoutManager为横向和竖向的情况，无它，只是画的位置不同而已。<br>话不多说了，上代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.widget.RecyclerView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewTypeDivider</span> <span class="keyword">extends</span> <span class="title">ItemHolderDivider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">keyFrom</span><span class="params">(RecyclerView.ViewHolder holder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> holder.getItemViewType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewTypeDivider <span class="title">put</span><span class="params">(<span class="keyword">int</span> viewType, Drawable drawable)</span> </span>&#123;</span><br><span class="line">        putDrawable(viewType, drawable);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewTypeDivider <span class="title">put</span><span class="params">(<span class="keyword">int</span> viewType, <span class="meta">@Nullable</span> Drawable drawable, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        putHeight(viewType, drawable, height);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect;</span><br><span class="line"><span class="keyword">import</span> android.graphics.drawable.Drawable;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.support.v4.util.SparseArrayCompat;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.widget.LinearLayoutManager;</span><br><span class="line"><span class="keyword">import</span> android.support.v7.widget.RecyclerView;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ItemHolderDivider</span> <span class="keyword">extends</span> <span class="title">RecyclerView</span>.<span class="title">ItemDecoration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseArrayCompat&lt;Drawable&gt; mDividers = <span class="keyword">new</span> SparseArrayCompat&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseArrayCompat&lt;Integer&gt; mHeights = <span class="keyword">new</span> SparseArrayCompat&lt;&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">keyFrom</span><span class="params">(RecyclerView.ViewHolder holder)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawOver</span><span class="params">(Canvas c, RecyclerView parent, RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = parent.getChildCount();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> width = parent.getWidth();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = parent.getHeight();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> childViewIndex = <span class="number">0</span>; childViewIndex &lt; childCount; childViewIndex++) &#123;</span><br><span class="line">            <span class="keyword">final</span> View view = parent.getChildAt(childViewIndex);</span><br><span class="line">            RecyclerView.ViewHolder holder = parent.getChildViewHolder(view);</span><br><span class="line">            <span class="keyword">int</span> key = keyFrom(holder);</span><br><span class="line">            <span class="keyword">if</span> (isVertical(parent)) &#123;</span><br><span class="line">                drawBottom(c, key, (<span class="keyword">int</span>) view.getY() + view.getHeight(), width);</span><br><span class="line">                drawTop(c, -key, (<span class="keyword">int</span>) view.getY(), width);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                drawRight(c, key, (<span class="keyword">int</span>) view.getX() + view.getWidth(), height);</span><br><span class="line">                drawLeft(c, -key, (<span class="keyword">int</span>) view.getX(), height);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getItemOffsets</span><span class="params">(Rect outRect, View view, RecyclerView parent,</span></span></span><br><span class="line"><span class="params"><span class="function">                               RecyclerView.State state)</span> </span>&#123;</span><br><span class="line">        RecyclerView.ViewHolder holder = parent.getChildViewHolder(view);</span><br><span class="line">        <span class="keyword">int</span> key = keyFrom(holder);</span><br><span class="line">        <span class="keyword">if</span> (isVertical(parent)) &#123;</span><br><span class="line">            outRect.bottom = getHeight(key);</span><br><span class="line">            outRect.top = getHeight(-key);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            outRect.right = getHeight(key);</span><br><span class="line">            outRect.left = getHeight(-key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawBottom</span><span class="params">(Canvas c, <span class="keyword">int</span> key, <span class="keyword">int</span> y, <span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">        Drawable d = mDividers.get(key);</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</span><br><span class="line">            d.setBounds(<span class="number">0</span>, y, width, y + getHeight(key, d));</span><br><span class="line">            d.draw(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawTop</span><span class="params">(Canvas c, <span class="keyword">int</span> key, <span class="keyword">int</span> y, <span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">        Drawable d = mDividers.get(key);</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</span><br><span class="line">            d.setBounds(<span class="number">0</span>, y - getHeight(key, d), width, y);</span><br><span class="line">            d.draw(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawRight</span><span class="params">(Canvas c, <span class="keyword">int</span> key, <span class="keyword">int</span> x, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        Drawable d = mDividers.get(key);</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</span><br><span class="line">            d.setBounds(x, <span class="number">0</span>, x + getHeight(key, d), height);</span><br><span class="line">            d.draw(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawLeft</span><span class="params">(Canvas c, <span class="keyword">int</span> key, <span class="keyword">int</span> x, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        Drawable d = mDividers.get(key);</span><br><span class="line">        <span class="keyword">if</span> (d != <span class="keyword">null</span>) &#123;</span><br><span class="line">            d.setBounds(x - getHeight(key, d), <span class="number">0</span>, x, height);</span><br><span class="line">            d.draw(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">putDrawable</span><span class="params">(<span class="keyword">int</span> key, Drawable drawable)</span> </span>&#123;</span><br><span class="line">        mDividers.put(key, drawable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">putHeight</span><span class="params">(<span class="keyword">int</span> key, <span class="meta">@Nullable</span> Drawable drawable, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mDividers.put(key, drawable);</span><br><span class="line">        &#125;</span><br><span class="line">        mHeights.put(key, height);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        Drawable d = mDividers.get(key);</span><br><span class="line">        <span class="keyword">return</span> getHeight(key, d);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getHeight</span><span class="params">(<span class="keyword">int</span> key, <span class="meta">@Nullable</span> Drawable d)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = mHeights.indexOfKey(key);</span><br><span class="line">        <span class="keyword">return</span> index &lt; <span class="number">0</span> ? d == <span class="keyword">null</span> ? <span class="number">0</span> : d.getIntrinsicHeight() : mHeights.valueAt(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isVertical</span><span class="params">(RecyclerView parent)</span> </span>&#123;</span><br><span class="line">        RecyclerView.LayoutManager layoutManager = parent.getLayoutManager();</span><br><span class="line">        <span class="keyword">return</span> !(layoutManager <span class="keyword">instanceof</span> LinearLayoutManager) ||</span><br><span class="line">                ((LinearLayoutManager) layoutManager).getOrientation() == LinearLayoutManager.VERTICAL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-backgroundcolorspan-wrap-text-only" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/12/22/backgroundcolorspan-wrap-text-only/">只包裹文本的BackgroundColorSpan</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-12-22T03:06:27.000Z" itemprop="datePublished">Dec 22 2017</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p><code>BackgroundColorSpan</code>可以实现文本加底色的一个效果，没有问题，然而问题是文本增加间距的时候效果会变成这样:<br><img src="http://upload-images.jianshu.io/upload_images/19161-0bb74bacf2a8bdf7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br>所以我们期望达到的效果是一个只包裹文本的的背景底色。<br>研究了一下，发现必须得到文本相关的信息，才能在指定的位置填充颜色，所以无法再利用<code>BackgroundColorSpan</code>这个类了，而要用<code>ReplacementSpan</code>，于是有:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class BorderSpan extends ReplacementSpan &#123;</span><br><span class="line">    private int mWidth;</span><br><span class="line">    private int mBackgroundColor;</span><br><span class="line"></span><br><span class="line">    public BorderSpan(@ColorInt int backgroundColor) &#123;</span><br><span class="line">        mBackgroundColor = backgroundColor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int getSize(@NonNull Paint paint, CharSequence text, int start, int end,</span><br><span class="line">                       Paint.FontMetricsInt fm) &#123;</span><br><span class="line">        mWidth = (int) paint.measureText(text, start, end);</span><br><span class="line">        return mWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void draw(@NonNull Canvas canvas, CharSequence text, int start, int end,</span><br><span class="line">                     float x, int top, int y, int bottom, @NonNull Paint paint) &#123;</span><br><span class="line">        int color = paint.getColor();</span><br><span class="line">        if (mBackgroundColor != 0) &#123;</span><br><span class="line">            paint.setStyle(Paint.Style.FILL);</span><br><span class="line">            paint.setColor(mBackgroundColor);</span><br><span class="line">            canvas.drawRect(x, top, x + mWidth, bottom, paint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而发现效果竟然和<code>BackgroundColorSpan</code>一样！显然这里需要在<code>bottom</code>上作文章。这时候需要了解一些字体相关的知识:<br><img src="http://upload-images.jianshu.io/upload_images/19161-3fe6386ac331457b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br>并且需要知道的是<code>ascent</code>，<code>descent</code>是相对于baseline的值，所以<code>ascent</code>经常是负值，而对应的类便是<code>Paint.getFontMetrics()</code>的<code>FontMetrics</code>, 在类字段描述中有这样一段:<br><img src="http://upload-images.jianshu.io/upload_images/19161-7577b2fed36609fe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br>所以最终用到的是这个字段，<code>draw</code>方法需要知道的重要一点是，这里的<code>y</code>就是字体信息对应的<code>baseline</code>，于是有:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void draw(@NonNull Canvas canvas, CharSequence text, int start, int end,</span><br><span class="line">                 float x, int top, int y, int bottom, @NonNull Paint paint) &#123;</span><br><span class="line">    int color = paint.getColor();</span><br><span class="line">    bottom = (int) (y + paint.getFontMetrics().bottom);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果终于达到了:<br><img src="http://upload-images.jianshu.io/upload_images/19161-77992934e1917cc0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br>如果不用bottom而用descent呢？<br>大家可以试验下，只是包裹的边界很靠近文本而已。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-reuse-layoutmanager" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/11/10/reuse-layoutmanager/">重用LayoutManager</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-11-10T11:32:23.000Z" itemprop="datePublished">Nov 10 2017</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>在RecyclerView嵌套RecyclerView的情况中，里层RecyclerView(Secondary RecyclerView)所在的ViewHolder将会与数据进行绑定，它当然需要设置一个LayoutManager。然而在onBindViewHolder方法中创建LayoutManger实例毕竟不太好，每次调用onBindViewHolder都有实例生成容易产生内存碎片。于是每个数据Item去持有一个LayoutManger实例是自然而然的。但是问题来了：<br>如果一个数据Item已经和一个ViewHolder绑定过或者说该位置的LayoutManager已经和一个recyclerView绑定过，这时在onBindViewHolder中要和另外一个ViewHolder实例进行绑定，直接设置会有异常抛出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: LayoutManager android.support.v7.widget.GridLayoutManager@33d32b28 is already attached to a RecyclerView:</span><br></pre></td></tr></table></figure>
<p>我们很自然的想到需要在Viewholder被回收的时候将RecyclerView的LayoutManger置空:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBindViewHolder</span><span class="params">(ViewHolder viewHolder, <span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">    viewHolder.recyclerView.setLayoutManager(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而是不行的！原因是时机的问题：复用ViewHolder未必需要先将ViewHolder回收，在ViewHolder移出ViewPort后并且有同一类型的ViewHolder需要展示当然直接被绑定。<br>所以我们需要先把LayoutManager中已经绑定的RecyclerView移除，但是找不到方法可以这么做！<br>查看源码LayoutManager持有一个recyclerView的实例，所以只要设置这个实例为空就可以了，而这个recyclerView的成员是包名访问的，只要创建一个同名包的方法就可以了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">package android.support.v7.widget;</span><br><span class="line">public final class RecyclerViewUtils &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以访问LayoutManger的<code>mRecyclerView</code>和它的<code>setRecyclerView</code>方法了。<br>然而直接调用setRecyclerView也是不行的！<br>RecyclerView在和LayoutManger绑定后作了很多设置和状态记录需要将其一并清除，否则在视图上会有紊乱。正确的作法是调用recyclerView的<code>setLayoutManager</code>方法。<br>于是终于有:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">detachLayoutManager</span><span class="params">(LayoutManager manager)</span> </span>&#123;</span><br><span class="line">  RecyclerView old = manager == <span class="keyword">null</span> ? <span class="keyword">null</span> : manager.mRecyclerView;</span><br><span class="line">  <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">    old.setLayoutManager(<span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在onBind的时候终于可以不用再创建LayoutManger了！而且运行的很好～</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-textview-multiple-line-ellipsize" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/11/07/textview-multiple-line-ellipsize/">TextView多行文本Ellipsize的终极解决方案</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-11-07T01:24:41.000Z" itemprop="datePublished">Nov 7 2017</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>Android的TextView提供了ellipse的功能，就是在文本超过指定行数maxLine后增加<code>...</code>，然而当<code>setText</code>传入是spannable类型的时候，这个功能无法生效。spannable中会包含不少信息，图片，下划线等等，给解决这个问题又增加了不少难度。微信朋友圈的”全文/收起”根本没加<code>...</code>。网上有很多人试图解决这个问题，有重写类的，例如 <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/6763689">https://stackoverflow.com/a/6763689</a>, 有添加布局监听的，如 <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/30446822%EF%BC%8C">https://stackoverflow.com/a/30446822，</a> 但实践下来没一个好用的！只好自己想法。</p>
<p>自己从头写文本布局是绝无可能的，TextView自己的代码就有几千行，更不要说StaticLayout, DynamicLayout工具类了，有些人提到<code>TextUtils.ellipsize</code>这个方法，但它只是应用在单行情况。于是想到多行文本是由单行组成，让<code>TextUtils.ellipsize</code>测量指定行数次，只在最后一次给出实际测量宽度不就可以了，根据源码写出:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//给定字符串和行数，返回缩略在字符串中的起始位置</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ellipsize</span><span class="params">(TextPaint tp, CharSequence cs, <span class="keyword">int</span> line, <span class="keyword">int</span> lineWidth)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> range[] = &#123;<span class="number">0</span>, cs.length(), <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> row = <span class="number">0</span>;</span><br><span class="line">    TextUtils.EllipsizeCallback cb = <span class="keyword">new</span> TextUtils.EllipsizeCallback() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ellipsized</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        range[<span class="number">0</span>] = start;  <span class="comment">// 单行文本缩略起始</span></span><br><span class="line">        range[<span class="number">1</span>] = end;    <span class="comment">// 单行文本缩略结束</span></span><br><span class="line">        range[<span class="number">2</span>] += start; <span class="comment">// 整个文本缩略位置</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">float</span> ellipsisWidth = tp.measureText(ELLIPSIS_STRING);</span><br><span class="line">    CharSequence remain = cs.subSequence(range[<span class="number">0</span>], cs.length());</span><br><span class="line">    <span class="comment">// 计算每行容纳的文本子串</span></span><br><span class="line">    <span class="keyword">while</span> (range[<span class="number">0</span>] &lt; range[<span class="number">1</span>] &amp;&amp; row &lt; line) &#123;</span><br><span class="line">      <span class="keyword">float</span> actualWidth = lineWidth + (row == line - <span class="number">1</span> ? <span class="number">0</span> : ellipsisWidth);</span><br><span class="line">      remain = remain.subSequence(range[<span class="number">0</span>], remain.length());</span><br><span class="line">      TextUtils.ellipsize(cs.subSequence(range[<span class="number">2</span>], cs.length()),</span><br><span class="line">          tp, actualWidth, TextUtils.TruncateAt.END, <span class="keyword">false</span>, cb);</span><br><span class="line">      row++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> range[<span class="number">0</span>] &lt; range[<span class="number">1</span>] ? range[<span class="number">2</span>] : -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>试验了一下居然很好用，无论是String还是Spannable都可以显示<code>...</code>了！然而问题马上来了，当文本中有连续英文字符时，显示有问题！发现验证的几个示例都是中文，换成英文就容易出问题。于是查原因，发现是因为断行，如果有”jisdfls”在行尾的时候需要在<code>d</code>这个字符处需要折行，虽然它不是合法的英文单词，但是布局会把整个单词都作为下一行的行首，这样之前的方法整个就错误了，因为这个方法根本没有折行的判断逻辑，而折行的判断逻辑很复杂！于是看StaticLayout这个负责文本布局的类，看能不能抽取些方法单独使用，然而这几乎是不可能的。StaticLayout中断行用了不少非开放的类比如<code>MeasuredText</code>，而这些类在不同的API实现还不一样！</p>
<p>#最终<br>但是办法还是想出来了，就是结合StaticLayout和TextUtils.ellipsize，由StaticLayout负责断行，在指定行数由TextUtils.ellipsize负责判断<code>...</code>的起始位置，避免各种实际的CharSequence类型的处理，这样这个问题终于圆满解决了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ellipsize</span><span class="params">(TextPaint tp, CharSequence cs, <span class="keyword">int</span> line, <span class="keyword">int</span> lineWidth)</span> </span>&#123;</span><br><span class="line">  StaticLayout layout = <span class="keyword">new</span> StaticLayout(cs, tp, lineWidth, Alignment.ALIGN_NORMAL,</span><br><span class="line">      <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">int</span> count = layout.getLineCount();</span><br><span class="line">  <span class="keyword">int</span> pos = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (count &gt; line) &#123;</span><br><span class="line">    <span class="keyword">int</span> start = layout.getLineStart(line - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> range[] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    TextUtils.ellipsize(cs.subSequence(start, cs.length()), tp, lineWidth,</span><br><span class="line">        TextUtils.TruncateAt.END, <span class="keyword">false</span>, <span class="keyword">new</span> TextUtils.EllipsizeCallback() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ellipsized</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">            range[<span class="number">0</span>] = start;  <span class="comment">// 单行文本缩略起始</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    pos = start + range[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个方法相比原有的操作相当于多了一次布局，然而实现简单轻量，甚至带着几分优雅～<br>#怎样显示在TextView中<br>首先指定宽度从哪来，View在刚inflate出来后是完全没有宽度的，而GlobalLayoutListener会被多次调用，所以方法只能写在onMeasure中，并且有了onMeasure就可以获取TextPait。知道了缩略起始位置就可以把原始字符串中该位置以后的内容替换成<code>...</code>, 再setText().</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-gesturedetector-long-click-could-not-cancel" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/06/29/gesturedetector-long-click-could-not-cancel/">GestureDetector无法取消长按</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-06-29T10:58:20.000Z" itemprop="datePublished">Jun 29 2017</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>期望对RecyclerView中的item可以做单击, 长按, 和拖拽操作, 利用<code>OnItemTouchListener</code>可以达到一个在外部总控的目的。一般的对Item的操作都是在Item内部定义一个OnClickListener，如果Item的点击之类的操作与外部无关并且Item内部状态各不相同， 那这样做是最好的，但如果需要和外部关联并且这些操作不会对个别的Item另作处理，这样做就有些不足，通常这样的操作是各个Item持有同一个操作实例， 这就是所谓“外部总控”。</p>
<p>比如：对一个Item长按，item自己状态变成selected或者checked, 同时外部界面变成编辑界面，Item的操作各不相同，但变成编译界面不区别具体某个Item，这样一个操作不仅涉及Item内部状态数据的变化，也涉及外部操作响应。<code>OnItemTouchListener</code>的好处就是能够统一在recyclerView层进行Touch事件的操作而同时不影响Item内部设置的各个Touch事件。<br><strong>但是</strong>，现实却是另一回事，实践了一下<code>OnItemTouchListener</code>却没有达到预想的目的。</p>
<p>一般的，利用<code>OnItemTouchListener</code>这个接口需要再用到GestureDetector这个对象。<br>声明了对一个Item的操作接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnItemClickListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(RecyclerView.ViewHolder holder)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(RecyclerView.ViewHolder holder)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">startDragging</span><span class="params">(RecyclerView.ViewHolder holder, MotionEvent e)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>GestureDetector.SimpleOnGestureListener</code>的<code>onSingleTapUp</code>响应<code>onItemClick</code>, <code>onLongPress</code>响应<code>onItemLongClick</code>，<code>onDown</code>里外部决定是否可拖拽<code>startDragging</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RecyclerItemTouchHandler</span> <span class="keyword">implements</span> <span class="title">RecyclerView</span>.<span class="title">OnItemTouchListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OnItemClickListener mListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GestureDetectorCompat mGestureDetector;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RecyclerItemTouchHandler</span><span class="params">(<span class="keyword">final</span> RecyclerView rv, OnItemClickListener listener)</span> </span>&#123;</span><br><span class="line">        mListener = listener;</span><br><span class="line">        GestureDetector.OnGestureListener gestureListener = <span class="keyword">new</span> GestureDetector.SimpleOnGestureListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSingleTapUp</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">                android.util.Log.d(<span class="string">&quot;wesley&quot;</span>, <span class="string">&quot;RecyclerItemTouchHandler.onSingleTapUp&quot;</span>);</span><br><span class="line">                View child = rv.findChildViewUnder(e.getX(), e.getY());</span><br><span class="line">                <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mListener.onItemClick(rv.getChildViewHolder(child));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.onSingleTapUp(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLongPress</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">                View child = rv.findChildViewUnder(e.getX(), e.getY());</span><br><span class="line">                <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mListener.onItemLongClick(rv.getChildViewHolder(child));</span><br><span class="line">                &#125;</span><br><span class="line">                android.util.Log.d(<span class="string">&quot;wesley&quot;</span>, <span class="string">&quot;RecyclerItemTouchHandler.onLongPress&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDown</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">                View child = rv.findChildViewUnder(e.getX(), e.getY());</span><br><span class="line">                <span class="keyword">boolean</span> handled = child != <span class="keyword">null</span> &amp;&amp; mListener.startDragging(rv.getChildViewHolder(child), e);</span><br><span class="line">                <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">                    mGestureDetector.setIsLongpressEnabled(<span class="keyword">false</span>);</span><br><span class="line">                    android.util.Log.d(<span class="string">&quot;wesley&quot;</span>, <span class="string">&quot;RecyclerItemTouchHandler.onDown&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> handled || <span class="keyword">super</span>.onDown(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        mGestureDetector = <span class="keyword">new</span> GestureDetectorCompat(rv.getContext().getApplicationContext(),</span><br><span class="line">                gestureListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mGestureDetector.onTouchEvent(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTouchEvent</span><span class="params">(RecyclerView rv, MotionEvent e)</span> </span>&#123;</span><br><span class="line">        android.util.Log.d(<span class="string">&quot;wesley&quot;</span>, <span class="string">&quot;RecyclerItemTouchHandler.onTouchEvent&quot;</span>);</span><br><span class="line">        mGestureDetector.onTouchEvent(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestDisallowInterceptTouchEvent</span><span class="params">(<span class="keyword">boolean</span> disallowIntercept)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hitTest</span><span class="params">(View view, <span class="keyword">float</span> x, <span class="keyword">float</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> location[] = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        view.getLocationOnScreen(location);</span><br><span class="line">        <span class="keyword">int</span> viewX = location[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">int</span> viewY = location[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">return</span> (x &gt; viewX &amp;&amp; x &lt; (viewX + view.getWidth())) &amp;&amp;</span><br><span class="line">                (y &gt; viewY &amp;&amp; y &lt; (viewY + view.getHeight()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>startDragging</code>的实现中利用<code>ItemTouchHelper</code>的来做具体操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">view.addOnItemTouchListener(<span class="keyword">new</span> RecyclerItemTouchHandler(view, <span class="keyword">new</span> RecyclerItemTouchHandler.OnItemClickListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemClick</span><span class="params">(RecyclerView.ViewHolder holder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mPresenter.isEdit()) &#123;</span><br><span class="line">            <span class="keyword">int</span> pos = holder.getAdapterPosition();</span><br><span class="line">            <span class="keyword">boolean</span> selected = !mPresenter.isSelected(pos);</span><br><span class="line">            mPresenter.selectProvider(pos, selected);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemLongClick</span><span class="params">(RecyclerView.ViewHolder holder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mPresenter.setEdit(<span class="keyword">true</span>) &amp;&amp;</span><br><span class="line">                mPresenter.selectProvider(holder.getAdapterPosition(), <span class="keyword">true</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startDragging</span><span class="params">(RecyclerView.ViewHolder holder, MotionEvent e)</span> </span>&#123;</span><br><span class="line">        View drag = holder.itemView.findViewById(R.id.drag_icon);</span><br><span class="line">        <span class="keyword">boolean</span> handled = drag != <span class="keyword">null</span> &amp;&amp; RecyclerItemTouchHandler.hitTest(drag,</span><br><span class="line">                e.getRawX(), e.getRawY());</span><br><span class="line">        <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">            mTouchHelper.startDrag(holder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这一切是那么的完美，<strong>然而</strong>实现的效果却是在拖拽的过程中响应了<code>onLongPress</code>的事件！费了半天劲找原因，看了下<code>GestureDetector</code>源码，原来是因为在<code>onDown</code>中并没有取消<code>LONG_PRESS</code>的消息:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (mIsLongpressEnabled) &#123;</span><br><span class="line">    mHandler.removeMessages(LONG_PRESS);</span><br><span class="line">    mHandler.sendEmptyMessageAtTime(LONG_PRESS, mCurrentDownEvent.getDownTime()</span><br><span class="line">            + TAP_TIMEOUT + LONGPRESS_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line">mHandler.sendEmptyMessageAtTime(SHOW_PRESS, mCurrentDownEvent.getDownTime() + TAP_TIMEOUT);</span><br><span class="line">handled |= mListener.onDown(ev);</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>也就是说即使onDown返回<code>true</code>，<code>LONG_PRESS</code>的消息还是发出了。这与我们通常对Touch事件的理解有些不同，为啥要这样写呢？我认为应该改成这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">handled |= mListener.onDown(ev);</span><br><span class="line"><span class="keyword">if</span> (!handled &amp;&amp; mIsLongpressEnabled) &#123;</span><br><span class="line">    mHandler.removeMessages(LONG_PRESS);</span><br><span class="line">    mHandler.sendEmptyMessageAtTime(LONG_PRESS, mCurrentDownEvent.getDownTime()</span><br><span class="line">            + TAP_TIMEOUT + LONGPRESS_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>但是不管怎样，因为GestureDetector无法取消长按，没法用这种实现了，最后在外部还是用了<code>View.OnClickListener</code>，<code>View.OnLongClickListener</code>，<code>View.OnTouchListener</code>，显然，在<code>OnTouchListener</code>中由于返回了<code>true</code>, <code>OnLongClickListener</code>无法被响应。但是这种实现有个不好的点是在执行<code>onBindViewHolder</code>时不能在对应的View上再设置或者覆盖其它的Listener了，否则操作失效。</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-notes-about-c11" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/06/14/notes-about-c11/">C++11笔记</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-06-14T02:49:55.000Z" itemprop="datePublished">Jun 14 2017</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h1 id="友元类是模板类的声明"><a href="#友元类是模板类的声明" class="headerlink" title="友元类是模板类的声明"></a>友元类是模板类的声明</h1><p>有一个类成员私有，希望指定的模板类可以访问，比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">    A* next;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template&lt;T&gt;</span><br><span class="line">class Container &#123;</span><br><span class="line">    T array[5];</span><br><span class="line">public:</span><br><span class="line">    typedef T container_type;</span><br><span class="line">    T access() &#123;</span><br><span class="line">        T a = array[0];</span><br><span class="line">        a.next = ...;</span><br><span class="line">        return a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Container&lt;A&gt; container;</span><br></pre></td></tr></table></figure>
<p>只希望Container能访问私有成员, 其它的任何类不可以。直接声明会有编译错误，当然如果把<code>A</code>声明成<code>struct</code>可以解决问题，但是要达到数据封装的目的就必须用到friend关键字:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class A &#123;</span><br><span class="line">    template&lt;typename T&gt;</span><br><span class="line">    friend class Container;</span><br><span class="line">    A* next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这样就可以编译通过了，如果有另一个类<code>B</code>也希望只有<code>Container</code>能访问私有, 那么<code>B</code>也必须作如此的声明, 于是每个特化的模板参数必须都在模板参数的类中作如此的声明否则就有编译错误，而且需要注意<code>typename</code>的情况:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename C&gt;</span><br><span class="line">class Array &#123;</span><br><span class="line">    C c;</span><br><span class="line">public:</span><br><span class="line">    typename C::container_type access() &#123;</span><br><span class="line">        return c.access();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template&lt;typename T&gt;</span><br><span class="line">using ArrayContainer = Array&lt;Container&lt;T&gt;&gt;;</span><br><span class="line"></span><br><span class="line">ArrayContainer&lt;A&gt; array;</span><br><span class="line">A a = array.access();</span><br></pre></td></tr></table></figure>
<p><code>Container&lt;T&gt;</code>本身作为模板参数传给另一个类<code>Array</code>，并且<code>Array</code>实现了同一个接口方法，这时候A对应的friend类依然是<code>Container</code>而不能是其它的类，否则会有编译错误，这意味着我们需要找到实际操纵A这个类型的类，在它范围内声明friend。<br>实际的应用会比这个复杂，如果作为模板参数类型的A本身也是一个<code>typename</code>那就需要既找到外部操纵类的原始类型,还要找到被操作类型的原始类型。</p>
<p>#typedef类型的前置声明</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class A;</span><br><span class="line">class B &#123;</span><br><span class="line">public:</span><br><span class="line">    void foo(A::value_type&amp; v);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">class A &#123;</span><br><span class="line">    typedef something value_type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>typedef</code>定义的类型<strong>无法</strong>前置声明。这意味着必须把<code>typedef</code>定义语句头文件include进来, 相关的信赖引用就得都include进来</p>
<p>#new操作封装(wrapper)<br>在new一个对象的时候希望作跟踪或者其它操作，最好是封装成一个函数，在函数体内部再做其他操作。但是类的构造函数的类型和个数都是不定的，为了实现就必须用到模板类不定参数:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T, typename... ARGS&gt;</span><br><span class="line">static T* alloc(ARGS&amp;&amp;... args) &#123;</span><br><span class="line">    return new T(std::forward&lt;ARGS&gt;(args)...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">alloc&lt;int&gt;()...</span><br></pre></td></tr></table></figure>
<p>std::forward<ARGS>表示ARGS的各个类型继续保持传入函数时的类型，以作为T的构造函数参数类型，主要是为了解决右值问题。</p>
<p>#不定参数函数的封装<br>说到不定参数，怎么样封装一个不定参数的函数？比如想给指定的格式化输出带颜色，但格式化输出的参数是不定参数，这时候不能直接使用printf，而要用vprintf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cstdarg&gt;</span><br><span class="line">#include &lt;cstdio&gt;</span><br><span class="line">void log(const char *format, ...) &#123;</span><br><span class="line">    printf(&quot;\033[1;33m&quot;); // 文本以黄色输出</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, format);</span><br><span class="line">    vprintf(format, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#模板形式的面向接口编程<br>无论C++还是Java典型的面向接口是将接口声明成虚函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//c++</span><br><span class="line">class listener &#123;</span><br><span class="line">    virtual void on_click() = 0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//java</span><br><span class="line">public interface listener &#123;</span><br><span class="line">    void onClick();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>于是各种子类以继承形式来实现接口，再在运行时找到实际对应的成员函数实体。而现代C++的形式则是利用模板, 在<a href="">友元类是模板类的声明</a>这个例子中充分说明了这种实现方式, 无论是<code>Container</code>还是<code>Array</code>, 都实现了<code>A access()</code>这个函数接口,只是在<code>Array</code>中以<code>typename C::container_type</code>形式假定了模板参数类型提供了真实的操纵类型,所以<code>Container</code>及类似的外部操纵类型都强制提供一个<code>container_type</code>。<br>这个例子中<code>Array</code>也可以写成如下形式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename C&gt;</span><br><span class="line">class Array: private C &#123;</span><br><span class="line">public:</span><br><span class="line">    typename C::container_type access() &#123;</span><br><span class="line">        return C::access();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>但模板编程有一个原则: 钟爱组合而不是继承, 组合能够提供更大的灵活性。</p>
<p>#线程存储对象的定义与声明<br>通过<code>thread_local</code>关键字的修饰，可以将一个类型的某一变量声明成线程对象:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class ThreadObject &#123;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//全局对象的外部初始化</span><br><span class="line">thread_local ThreadObject _t_obj;</span><br></pre></td></tr></table></figure>
<p>在linux上线程对象用了写时拷贝，在任何一个线程内引用_t_obj时才调用ThreadObject的构造函数。</p>
<p>现在问题来了，希望这个类只能作为线程对象存在，不能在堆或栈自行定义，也就是说构造函数必须私有。构造函数一旦私有上述代码就会有<code>error: ‘ThreadObject::ThreadObject()’ is private</code>的编译错误。我们即使提供静态函数来返回这个全局变量还是会有编译错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// ThreadObject.hh</span><br><span class="line">class ThreadObject &#123;</span><br><span class="line">    static thread_local ThreadObject _t_obj;</span><br><span class="line">public:</span><br><span class="line">    static ThreadObject&amp; get_obj();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ThreadObject.cc</span><br><span class="line">static thread_local ThreadObject _t_obj;</span><br><span class="line">ThreadObject &amp;ThreadObject::get_obj() &#123;</span><br><span class="line">    return _t_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外thread_local<strong>不能</strong>声明在类中！这样写会引起<code>TLS wrapper function for ...</code>的链接错误。<br>怎样才能既把构造函数私有又能静态全局引用？最关键的问题是不同的线程调用返回的是不同的对象？<br>乍看挺棘手的，其实却很简单，利用函数静态变量！<br>加上thread_local修饰，这样它是全局引用的但能够保持构造私有(因为是在类的作用域内)，关键是不同线程调用返回的是不同的对象!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// ThreadObject.hh</span><br><span class="line">class ThreadObject &#123;</span><br><span class="line">public:</span><br><span class="line">    static ThreadObject&amp; get_obj();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ThreadObject.cc</span><br><span class="line">ThreadObject &amp;ThreadObject::get_obj() &#123;</span><br><span class="line">    static thread_local ThreadObject _t_obj;</span><br><span class="line">    return _t_obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>#精度不同的时间比较<br>我们知道在<code>chrono</code>中，<code>时间点(time_point)+时间段(duration)=时间点</code>, 并且时间点的精度类型(duration)和时间段的精度类型可以不一致:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;chrono&gt;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    using milli_time = std::chrono::time_point&lt;std::chrono::system_clock, std::chrono::milliseconds&gt;;</span><br><span class="line">    milli_time tp(std::chrono::milliseconds(1));</span><br><span class="line">    std::cout &lt;&lt; &quot;milli_time_since_epoch: &quot; &lt;&lt; tp.time_since_epoch().count() &lt;&lt; std::endl;</span><br><span class="line">    tp += std::chrono::seconds(1);</span><br><span class="line">    std::cout &lt;&lt; &quot;milli_time_since_epoch: &quot; &lt;&lt; tp.time_since_epoch().count() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    using micro_time = std::chrono::time_point&lt;std::chrono::system_clock, std::chrono::microseconds&gt;;</span><br><span class="line">    micro_time tp2(std::chrono::milliseconds(1));</span><br><span class="line">    std::cout &lt;&lt; &quot;micro_time_since_epoch: &quot; &lt;&lt; tp2.time_since_epoch().count() &lt;&lt; std::endl;</span><br><span class="line">    tp2 += std::chrono::seconds(1);</span><br><span class="line">    std::cout &lt;&lt; &quot;micro_time_since_epoch: &quot; &lt;&lt; tp2.time_since_epoch().count() &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; &quot;compare1: &quot; &lt;&lt; (tp + std::chrono::microseconds(1) &lt; tp2) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    using hour_time = std::chrono::time_point&lt;std::chrono::system_clock, std::chrono::hours&gt;;</span><br><span class="line">    hour_time tp3(std::chrono::hours(0));</span><br><span class="line">    milli_time p(std::chrono::milliseconds(0));</span><br><span class="line">    std::cout &lt;&lt; &quot;compare2: &quot; &lt;&lt; (p + std::chrono::microseconds(1) &lt; tp3) &lt;&lt; std::endl;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>时间的比较有以下结论:</p>
<ol>
<li>低精度的时间不能用高精度的时间段初始化。<br><code>milli_time tp(std::chrono::microseconds(1));</code> 编译是错误的</li>
<li>低精度的时间也不能与高精度的时间段加合。<br><code>milli_time += std::chrono::microseconds(1)</code> 也是不正确的</li>
<li>精度不同的时间点可以比较。</li>
<li>精度不同的时间点可与精度的不同的时间段相加并与精度不同的时间点比较。</li>
</ol>
<p>#根据类型选择的模板选择<br>很多时候我们需要根据定义的类型自动匹配需要的函数,这时候就要用到模板特化来进行模板的选择。<br>仍以时间精度为例, 比如在某个系统上精度为milliseconds, 而在另一个系统上就保持默认的精度即可, 操作的接口应当是一致的, 所以我们很自然的用<code>typedef</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#ifdef SOME_OS</span><br><span class="line">typedef std::chrono::milliseconds       duration;</span><br><span class="line">#else</span><br><span class="line">typedef std::chrono::system_clock:duration       duration;</span><br><span class="line">#endif</span><br><span class="line">typedef std::chrono::time_point&lt;std::chrono::system_clock, duration&gt;       time_point;</span><br></pre></td></tr></table></figure>
<p>现在希望一个now()接口返回当前时间点,时间点是我们自定义精度对应的time_point, 如果是默认的精度直接返回<code>std::chrono::system_clock::now</code>避免一个<code>time_point_cast</code>的操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T&gt;</span><br><span class="line">time_point cast_now(T) &#123;</span><br><span class="line">    return std::chrono::time_point_cast&lt;message::duration&gt;(</span><br><span class="line">            sys_clock::now());</span><br><span class="line">&#125;</span><br><span class="line">// 特化的模板函数</span><br><span class="line">inline</span><br><span class="line">sys_clock::time_point cast_now(std::chrono::nanoseconds) &#123;</span><br><span class="line">    return std::chrono::system_clock::now();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">time_point now() &#123;</span><br><span class="line">    return cast_now&lt;duration&gt;(duration(0));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们定义duration为<code>std::chrono::milliseconds</code>则匹配默认的模板函数, 否则调用特化模板函数。当然只是一个例子,如果直接用宏更简单。<br>在不能用宏来区别的情况下, 假如有种情况是<code>std::chrono::milliseconds</code>或者<code>std::chrono::nanoseconds</code>是一个比较大的对象, 我们只是生成一个临时变更进行模板选择,这样会有无谓的开销,不是我们希望的。<br>原理还是按照模板类型匹配,只不过我们用以匹配的类型变成简单类型就可以了, 这里用到<code>std::conditional</code>和<code>std::is_same</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef std::conditional&lt;std::is_same&lt;std::chrono::system_clock::duration,</span><br><span class="line">            duration&gt;::value, void*, int&gt;::type         now_type;</span><br><span class="line"></span><br><span class="line">time_point message::now() &#123;</span><br><span class="line">    return cast_now&lt;now_type&gt;(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果duration是和系统精度一样, 定义now_type为void*, 否则为int, 用now_type来进行模板匹配, 它的临时对象的开销是非常小的。</p>
<p>#lambda返回类型自动推断<br>一个函数通过一个lambda表达式返回一个模板类对象, 那么能否仅通过lambda表达式自动推断出模板类对象的类型?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename T&gt;</span><br><span class="line">class Job &#123;</span><br><span class="line">public:</span><br><span class="line">    Job(T&amp;&amp; t) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">template&lt;typename T&gt;</span><br><span class="line">Job&lt;T&gt; create_job(std::function&lt;T()&gt;&amp;&amp; f) &#123;</span><br><span class="line">    return Job&lt;T&gt;(f());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv) &#123;</span><br><span class="line">    Job&lt;int&gt; t = create_job([] &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>答案是不行。会有<code>error: no matching function for call to ‘create_job ...</code>的错误, 根本原因是生成的lambda类型根本没带返回值的类型, 所以无法自动推断出返回的<code>Job&lt;T&gt;</code>类型, 只能明确把类型给带上: <code>create_job&lt;int&gt;([] &#123;</code>, ,这实在不美观。<br>通用的解决办法是把整个可调用对象声明成模板参数:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">template&lt;typename _Call&gt;</span><br><span class="line">auto create_job(_Call&amp;&amp; call) -&gt; Job&lt;decltype(call())&gt; &#123;</span><br><span class="line">    using T = decltype(call());</span><br><span class="line">    return Job&lt;T&gt;(call());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char **argv) &#123;</span><br><span class="line">    Job&lt;int&gt; j = create_job([] &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然美观了, 可这样写意味着我们没法维持一个固定的接口, 随着各种lambda或者可调用对象的模板特化,会生成大量的<code>create_job</code>对应的代码, 感觉容易引起代码膨胀。</p>
<p>#避免条件变量唤醒后又阻塞<br>假如多线程的代码在某一点A处于等待状态:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::unique_lock&lt;std::mutex&gt; lk(_lock);</span><br><span class="line">_cv.wait(lk)</span><br></pre></td></tr></table></figure>
<p>另一处B需要改变数据:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::lock_guard&lt;std::mutex&gt; lk(_lock);</span><br><span class="line">var = ...;</span><br><span class="line">_cv.notify_one();</span><br></pre></td></tr></table></figure>
<p>这里有一个细节需要注意:<br>当<code>notify_one</code>执行的时候, 锁是没有释放的, <code>notify_one</code>是立即执行的,也就是说A处代码会立马得到通知,从等待状态唤醒过来, 开始从wait返回, 然而返回需要获取锁,由于锁没有释放, A处代码又立即变为阻塞状态, 等待锁的释放。这样是有比较大的开销的, 我们需要在通知前就释放锁:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    std::lock_guard&lt;std::mutex&gt; lk(_lock);</span><br><span class="line">    var = ...;</span><br><span class="line">&#125;</span><br><span class="line">_cv.notify_one();</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-fedora-install-and-config" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/08/04/fedora-install-and-config/">Fedora轻松安装与配置</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-08-04T03:46:56.000Z" itemprop="datePublished">Aug 4 2016</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>主要是用来做点记录，长点记性，不然每次都从头开始安装的时候都忘记一些小点，结果把整个过程拖的老长，浪费了不少时间。<br>#UEFI安装系统<br>####0. 准备工作－设置BIOS</p>
<ol>
<li>设置启动顺序<br>不同的机器有不同的BIOS，对应的名称位置都不太一样，需要自己能找到。一般在boot option -&gt; 高级 里面，将从USB启动放在从磁盘驱动前面。</li>
<li>打开UEFI启动开关<br>有些BIOS需要专门设置UEFI的启动开关，当前所用的HP 430 G3就是这样。</li>
<li>打开虚拟化设置<br>在Boot Option -&gt; Advanced -&gt; System Option中勾选Virtualization Technology(VTx), 这主要是为了以后方便安装其它工具。</li>
<li>安全启动设置<br>在Boot Option -&gt; Advanced 在 -&gt; Secure Boot Configuration 中选择legacy enable and secure boot disable， 不然可能引起无线网络的问题。</li>
</ol>
<p>####1. 下载<a target="_blank" rel="noopener" href="https://mbriza.fedorapeople.org/liveusb-creator.zip">liveusb-creator</a>来刻录ISO文件<br><font color="#f00"> 一定要用Fedora的专属软件否则无法成功制作启动U盘！</font> 被这个问题坑了很多次， 每次都忘记用…<br>####2. 分区<br>Fedora自20(?)版本之后都用GPT的磁盘分区格式， 这意味着如果机器要装双系统就没法再装MBR分区的系统比如Win7, 已经装了Win7也没法再装fedora了，但是再装Win8, Win10就没有问题， GPT应该是以后的标准配置，苹果也用的它。<br>在安装过程中会提示划分挂载点， 这个只要有足够多空余磁盘空间，点击“自动划分”一般没啥问题。</p>
<p>#安装无线网卡驱动<br>遇到的一个问题是系统成功安装在HP 430 G3的垃圾机器上却没有区域内的WIFI列表。首先要确定是否是硬件的问题，由于之前的系统装过windows并且能连wifi所以可以确定硬件没有问题。这样的情况一般就是驱动软件没安装合适，可能是镜像文件内的默认驱动没法正常工作。</p>
<ol>
<li>找到网卡驱动<br>运行<code>lspci | grep -i &quot;network&quot;</code></li>
<li>安装源内驱动<br><code>dnf search $Verdor</code> 搜索厂商驱动包再分别安装</li>
<li>安装厂商驱动<br>遇到的问题是已经安装了Broadcom的驱动还是不能工作，这样就只能从厂商网站上下载正确的Linux驱动安装包。网上搜索到<a target="_blank" rel="noopener" href="https://onpub.com/install-broadcom-linux-wi-fi-driver-on-fedora-23-s7-a192">这篇文章</a>可以了解下，虽然针对23但实际操作没有关系，脚本做了以下4个操作：</li>
<li>下载包</li>
<li>编译并安装包（安装需要root）</li>
<li>删除已有wireless内核模块并安装新模块</li>
<li>写入新配置<br>重启后终于看到wifi了。</li>
</ol>
<p>#启动ssh服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl stop sshd.service</span><br><span class="line"># systemctl start sshd.service</span><br></pre></td></tr></table></figure>

<p>#安装输入法</p>
<ol>
<li>安装输入法包比如极点五笔 <code>dnf install ibus-table-chinese-wubi-jidian.noarch</code></li>
<li>运行<code>ibus-setup</code> 在配置界面加入新的输入法，没有ibus再安装ibus包<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export GTK_IM_MODULE=ibus</span><br><span class="line">export XMODIFIERS=@im=ibus</span><br><span class="line">export QT_IM_MODULE=ibus</span><br></pre></td></tr></table></figure></li>
<li>重启机器后配置好的输入法还是无法显示？<br>需要加入ibus-daemon到自动重启，每种桌面环境的自动重启配置界面不同， 在Xfce中Applications -&gt; Settings -&gt; Session&amp;Startup, 添加命令<code>ibus-daemon -d</code><br>可是有时系统重启以后明明已经有输入法的图标在任务栏上显示，可是就是无法输入汉字，再重启后又可以使用了，不知道啥原因…</li>
</ol>
<p>#安装Docker<br>所有操作都需要root权限, $USER对应的是当前普通用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dnf install docker</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">groupadd docker</span><br><span class="line">chown root:docker /var/run/docker.sock</span><br><span class="line">usermod -a -G docker $USER</span><br></pre></td></tr></table></figure>
<p>重启机器，这样就能够以普通用户执行docker操作了。<br>####docker加载本地存储卷错误<br><code>docker run -v /path/to/volume:/path/to/dest</code>之前需要执行<br><code>chcon -Rt svirt_sandbox_file_t /path/to/volume</code></p>
<p>#安装Android32位兼容包<br><code>dnf install glibc.i686 zlib.i686 libgcc.i686</code></p>
<p>#运行samba<br><code>smbclient -N //10.140.60.128/&lt;share_name&gt;</code><br>share_name一定要是服务器上根目录，不能带路径</p>
<p>#安装quart</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install redhat-rpm-config Cython python2-devel</span><br></pre></td></tr></table></figure>
<p>#安装VirtualBox</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf install kernel-devel dkms kernel-headers</span><br><span class="line">/sbin/rcvboxdrv setup</span><br></pre></td></tr></table></figure>
<p>下载<a target="_blank" rel="noopener" href="https://www.virtualbox.org/wiki/Downloads">VM VirtualBox Extension Pack</a><br>#安装Bochs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install bochs bochs-debugger</span><br></pre></td></tr></table></figure>

<p>#编译Bochs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install libX11-devel libXrandr-devel</span><br></pre></td></tr></table></figure>

<p>#升级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dnf upgrade --refresh</span><br><span class="line">dnf install dnf-plugin-system-upgrade</span><br><span class="line">dnf system-upgrade download --releasever=31</span><br><span class="line">dnf system-upgrade reboot</span><br></pre></td></tr></table></figure>

<p>#升级后<br><a target="_blank" rel="noopener" href="https://fedoramagazine.org/upgrading-fedora-30-to-fedora-31/">fedoramagazine</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dnf copr enable librehat/shadowsocks</span><br><span class="line">dnf update &amp;&amp; dnf install shadowsocks-libev</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-my-tech-translation-rules" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2014/07/20/my-tech-translation-rules/">开始技术翻译实践</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2014-07-20T13:27:00.000Z" itemprop="datePublished">Jul 20 2014</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>最近在实现一个控件可以自适应布局的算法，看了一些资料，记录下来。<br>先是两个PPT slice，言简意赅的说明了布局（layout）是什么，针对的对象，所用的一般方法，和布局应用的一些小史。</p>
<p>语言的学习从来是一项重要的技能，翻译一下正好可以练习之。技术翻译一旦了解术语及其含义，相比文艺作品还是相当容易的。文艺作品相关的东西可能很多，时代背景国别情况文化差异甚至语言习惯，而技术翻译只要正确把握说明意图和技术概念应该是不难的——还是先从简单的做起来，不要想当然。</p>
<p>我的技术翻译的原则是：</p>
<ol>
<li><strong>语句通顺</strong></li>
<li><strong>含义明确</strong></li>
<li><strong>语词简单</strong></li>
</ol>
<p>第1，2点当然是最基本要求，但对于我国这样的文化大国来说却是不易的。我国据说现在的出版量已是世界第一，技术书籍更是汗牛充栋，但质量就不知了，起码在技术书这块无论是原版引进还是自己出版，在我有限的了解里真是太差了——再说国内也没有多少真正意义上的自己的原创技术书籍。那些烂书里一句话都读不下去，根本就是不明所以，文字堆到一块到底是要让人明白的，我一直恶意揣测这帮写字的家伙根本就没打算让人明白，无论是翻译还是总结都是生涩难懂，面目可憎。这也是我讨厌技术的一个原因，讨厌读技术书的一个原因。这种情况可能因为不是学技术的人书写或者翻译的，或者写字的这些技术人语言文字水平烂糟透顶！第一种情况是出版社不负责任应付差事，看技术书价高量大也就只想着赚钱，找来的人根本不知计算机语言为何物，还记得把SmallTalk译成“小谈话”么？第二种的情况可能更普遍，我国贫乏低劣的教育号称是“素质”但都是虚假和难以实施的，实质一直是应试，考试作文写的一溜溜的，但真要把别人的思想按自己的理解转成自己的语言就容易暴露本质。</p>
<p>把第2点专门提出来的原因是，单个的分句翻译的可能没有问题，意思明白语句通顺，但是把每个分句组成一句话后读起来却让人费解。文字归根结底是要让人明白道理，传递思想。含义明确才是最终目的，语句通顺只是手段。技术更是如此，如果我当初就深受其害，那现在继续重复我所厌恶的，我做的这件事就没有意义。</p>
<p>我个人十分厌恶的一种说话习气就是自顾自地说些不懂的语词，陌生的语词会带入受众一种陌生的语境，让交流者变得有距离。如果身处一群用不懂的词语说话的人中间会产生孤立感，如果对一群人说了大家都不知含义的词语则会产生疏离感。你看美帝总统们的演讲和竞选口号都是些很常用的词汇。码畜们在有非专业人士在场的情况下依旧会旁若无人的说起他们那一套技术词汇，让人半懂不懂的。文科或者艺术男女们倒是很少用专业词汇了但麻烦的是他们表达的时候，要么词语都是加入了自己的理解要么根本就用得不对要么和许多理工男一样根本说不清一句话，再加上说话语气里一股子飘飘忽忽的劲，真让人恨不得抽他们一巴掌。然而<strong>总体上</strong>文艺青年还是会比理工男们会表达(bai huo)。要表达好无它，只有多表达，说话是这样，书写也是这样。（咳，我作为码畜现在说话也是过少了，说话经常说不清楚……）</p>
<p>而我无论翻译任何东西，都尽量用简单的词汇，简单的句子；避免英语里各种丛句复合而成的高大上长句；尽量用口语化的语气而避免翻译腔，但又要保证不要与原文出入甚大，总之就是要翻译的对但读起来舒服一点，让文字更有亲合力一点。无可避免的是枯燥和无聊——除非不要搞技术……我甚至极端的认定标准是“信达俗”，技术翻译积重难返，只能矫枉过正。不过好在各种翻译组的状态趋势上似乎不赖，《码农》还有《图灵社区》什么的，这些搞资讯和媒体的都不错（主要是一些技术人的非技术文章）。还是那句老话，万事开头难，重要的是做起来！</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-opengl-from-left-bottom-to-left-top" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2014/06/21/opengl-from-left-bottom-to-left-top/">OpenGL的左下坐标原点转成窗口系统的左上坐标</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2014-06-21T03:42:22.000Z" itemprop="datePublished">Jun 21 2014</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>想当然的写成<code>gluOrtho2D(0, width, height, 0);</code> 但这是不对的。验证的方法是，只要画四条直线, width, height分别是窗口宽高：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">glBegin(GL_LINE_LOOP);</span><br><span class="line">    glColor3ub(<span class="number">0xFF</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    glVertex2i(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    glVertex2i(width, <span class="number">0</span>);</span><br><span class="line">    glVertex2i(width, height);</span><br><span class="line">    glVertex2i(<span class="number">0</span>, height);</span><br><span class="line">glEnd();</span><br></pre></td></tr></table></figure>
<p>应该只有左上两条直线能显示才对。但结果是右下两条显示了出来,把width+1, 则右边线条去掉了，所以整体的显示结果是向期望的向左上偏移了一个像素。<br>调整成这样才是正确的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gluOrtho2D(<span class="number">-1</span>, width - <span class="number">1</span>, height - <span class="number">1</span>, <span class="number">-1</span>);</span><br></pre></td></tr></table></figure>
<p>显然<code>gluOrtho2D</code>对于整数的取值区间是<code>(m, n]</code>。</p>
<p>程序在这种情况下真正做到了精确至像素，一个像素的错误（不是误差）让结果产生重大影响。真正的精确到像素只有可能是实在的数据运算而不是感觉和观察，不知设计湿看了作何想。</p>

      
    </div>
    
    
    
  </div>
</article>



  


  <nav id="page-nav" class="page-nav">
    
    <a class="extend prev" rel="prev" href="/categories/Tech/">« Prev</a><a class="page-number" href="/categories/Tech/">1</a><span class="page-number current">2</span><a class="page-number" href="/categories/Tech/page/3/">3</a><a class="extend next" rel="next" href="/categories/Tech/page/3/">Next »</a>
  </nav>



    </div>
  </div>
  


<script type="text/javascript">
let tgl=(s)=>{x=document.getElementsByName("expand");for(let i=0;i<x.length;i++)x[i].checked=s.checked;}
</script>



<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
